---
name: goreleaser
on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Leave empty for auto-generated notes'
        required: false
        type: string
        default: ''

env:
  GO_VERSION: '1.24.11'

jobs:
  # Build binaries on each platform
  build:
    name: Build ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - name: Linux
            os: ubuntu-latest
            build_ids:
              - server-linux
              - client-linux
              - client-linux-opencl
              - client-linux-cuda
            setup_cuda: true
            setup_opencl: true
          - name: macOS
            os: macos-latest
            build_ids:
              - server-darwin
              - client-darwin
              - client-darwin-opencl
            setup_cuda: false
            setup_opencl: false  # macOS has OpenCL built-in
          - name: Windows
            os: windows-latest
            build_ids:
              - server-windows
              - client-windows
              - client-windows-opencl
            setup_cuda: false
            setup_opencl: true

    steps:
      - name: Set up git repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: "**/*.sum"

      # Linux-specific dependencies
      - name: Install protobuf compiler (Linux)
        if: matrix.config.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install CUDA toolkit (Linux)
        if: matrix.config.setup_cuda
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          rm cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y cuda-toolkit-12-6
          echo "PATH=/usr/local/cuda/bin:$PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/lib64/stubs:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Install OpenCL headers (Linux)
        if: matrix.config.os == 'ubuntu-latest' && matrix.config.setup_opencl
        run: |
          sudo apt-get install -y opencl-headers ocl-icd-opencl-dev

      # macOS-specific dependencies
      - name: Install protobuf compiler (macOS)
        if: matrix.config.os == 'macos-latest'
        run: brew install protobuf

      # Windows-specific dependencies
      - name: Install protobuf compiler (Windows)
        if: matrix.config.os == 'windows-latest'
        run: choco install protoc

      - name: Install OpenCL SDK (Windows)
        if: matrix.config.os == 'windows-latest' && matrix.config.setup_opencl
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          C:\vcpkg\vcpkg.exe install opencl --triplet=x64-windows
          "OPENCL_ROOT=C:\vcpkg\installed\x64-windows" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CGO_CFLAGS=-IC:\vcpkg\installed\x64-windows\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CGO_LDFLAGS=-LC:\vcpkg\installed\x64-windows\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # Common Go tools setup
      - name: Install Go tools
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Fix GOPATH (Unix)
        if: matrix.config.os != 'windows-latest'
        run: echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Fix GOPATH (Windows)
        if: matrix.config.os == 'windows-latest'
        shell: pwsh
        run: |
          $gopath = go env GOPATH
          "$gopath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # Install GoReleaser
      - name: Set up GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: latest
          install-only: true

      # Build binaries with platform-specific IDs
      - name: Build with GoReleaser
        shell: bash
        run: |
          ARGS=(build --snapshot --clean)
          IDS='${{ toJSON(matrix.config.build_ids) }}'
          for id in $(echo "$IDS" | jq -r '.[]'); do
            ARGS+=(--id "$id")
          done
          goreleaser "${ARGS[@]}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload binaries as artifacts
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.config.name }}
          path: dist/*
          retention-days: 1

  # Create unified release with all binaries
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Set up git repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Create and push tag (manual workflow)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ inputs.tag }}" -m "Release ${{ inputs.tag }}"
          git push origin "${{ inputs.tag }}"

      # Download all platform binaries
      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-Linux
          path: dist-linux

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-macOS
          path: dist-macos

      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-Windows
          path: dist-windows

      # Merge all binaries into single dist directory
      - name: Merge binaries
        run: |
          mkdir -p dist
          cp -r dist-linux/* dist/ || true
          cp -r dist-macos/* dist/ || true
          cp -r dist-windows/* dist/ || true
          ls -la dist/

      # Create archives for each binary
      - name: Create archives
        run: |
          cd dist
          echo "=== Contents of dist directory ==="
          ls -laR
          echo "==================================="

          # Find all binaries in subdirectories and create tar.gz/zip archives
          find . -type f \( -name "server" -o -name "client*" -o -name "*.exe" \) | while read -r file; do
            # Remove leading ./
            filename="${file#./}"
            # Get just the binary name without directory
            basename=$(basename "$filename")
            # Get the directory name for platform info
            dirname=$(dirname "$filename" | sed 's|^\./||')

            echo "Found binary: $filename"
            echo "  Basename: $basename"
            echo "  Directory: $dirname"

            # Create archive name from directory (e.g., server_linux_amd64_v1 -> server_linux_amd64)
            # shellcheck disable=SC2001
            archive_base=$(echo "$dirname" | sed 's/_v[0-9]*$//')

            case "$basename" in
              *.exe)
                # Windows binary - create zip
                archive_name="${archive_base}.zip"
                echo "Creating Windows archive: $archive_name"
                (cd "$(dirname "$filename")" && zip "../${archive_name}" "$(basename "$filename")")
                ;;
              *)
                # Unix binary - create tar.gz
                archive_name="${archive_base}.tar.gz"
                echo "Creating Unix archive: $archive_name"
                (cd "$(dirname "$filename")" && tar czf "../${archive_name}" "$(basename "$filename")")
                ;;
            esac
            echo "Created: $archive_name"
            echo "---"
          done

          echo ""
          echo "=== Created archives ==="
          ls -lh ./*.tar.gz ./*.zip 2>/dev/null || echo "No archives found!"
          echo "========================"

      # Determine release tag (needed for checksums filename)
      - name: Determine release tag
        id: release_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      # Generate checksums with proper GoReleaser naming convention
      - name: Generate checksums
        run: |
          cd dist
          echo "=== Generating checksums ==="
          # Use GoReleaser standard naming: <project>_<version>_checksums.txt
          CHECKSUM_FILE="redteamcoin_${{ steps.release_tag.outputs.tag }}_checksums.txt"
          echo "Checksum filename: $CHECKSUM_FILE"
          # Generate checksums for all archives
          sha256sum ./*.tar.gz ./*.zip > "$CHECKSUM_FILE" 2>/dev/null || echo "No archives found for checksums" > "$CHECKSUM_FILE"
          echo ""
          echo "=== Checksums ==="
          cat "$CHECKSUM_FILE"
          echo "================="

      # Validate archives were created
      - name: Validate release artifacts
        run: |
          cd dist
          echo "=== Validating release artifacts ==="
          archive_count=$(find . -maxdepth 1 \( -name "*.tar.gz" -o -name "*.zip" \) | wc -l)
          echo "Found $archive_count archives"

          if [ "$archive_count" -eq 0 ]; then
            echo "❌ ERROR: No archives were created!"
            echo "This likely means the binary discovery failed."
            exit 1
          fi

          CHECKSUM_FILE="redteamcoin_${{ steps.release_tag.outputs.tag }}_checksums.txt"
          if [ ! -f "$CHECKSUM_FILE" ]; then
            echo "❌ ERROR: $CHECKSUM_FILE not found!"
            exit 1
          fi

          checksum_size=$(stat -c%s "$CHECKSUM_FILE" 2>/dev/null || stat -f%z "$CHECKSUM_FILE")
          if [ "$checksum_size" -eq 0 ]; then
            echo "❌ ERROR: $CHECKSUM_FILE is empty!"
            exit 1
          fi

          echo "✓ Validation passed: $archive_count archives ready for release"
          echo "✓ Checksums file: $CHECKSUM_FILE"
          echo "===================================="

      # Create GitHub release with all artifacts
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          body: ${{ inputs.release_notes }}
          generate_release_notes: ${{ inputs.release_notes == '' }}
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/redteamcoin_*_checksums.txt
          draft: false
          prerelease: false
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
