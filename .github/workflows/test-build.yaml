---
name: Test Build Matrix
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

env:
  GO_VERSION: 1.23.5

jobs:
  # Test build binaries on each platform without creating release
  build:
    name: Build ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - name: Linux
            os: ubuntu-latest
            goreleaser_config: .goreleaser.linux.yaml
            setup_cuda: true
            setup_opencl: true
          - name: macOS
            os: macos-latest
            goreleaser_config: .goreleaser.macos.yaml
            setup_cuda: false
            setup_opencl: false  # macOS has OpenCL built-in
          - name: Windows
            os: windows-latest
            goreleaser_config: .goreleaser.windows.yaml
            setup_cuda: false
            setup_opencl: true

    steps:
      - name: Set up git repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: "**/*.sum"

      # Linux-specific dependencies
      - name: Install protobuf compiler (Linux)
        if: matrix.config.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install CUDA toolkit (Linux)
        if: matrix.config.setup_cuda
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          rm cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y cuda-toolkit-12-6
          echo "PATH=/usr/local/cuda/bin:$PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/lib64/stubs:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Install OpenCL headers (Linux)
        if: matrix.config.os == 'ubuntu-latest' && matrix.config.setup_opencl
        run: |
          sudo apt-get install -y opencl-headers ocl-icd-opencl-dev

      # macOS-specific dependencies
      - name: Install protobuf compiler (macOS)
        if: matrix.config.os == 'macos-latest'
        run: brew install protobuf

      # Windows-specific dependencies
      - name: Install protobuf compiler (Windows)
        if: matrix.config.os == 'windows-latest'
        run: choco install protoc

      - name: Install OpenCL SDK (Windows)
        if: matrix.config.os == 'windows-latest' && matrix.config.setup_opencl
        run: |
          choco install opencl-intel-cpu-runtime
          # Note: Full OpenCL SDK would be needed for development, but headers might be in the Go code already

      # Common Go tools setup
      - name: Install Go tools
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Fix GOPATH (Unix)
        if: matrix.config.os != 'windows-latest'
        run: echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Fix GOPATH (Windows)
        if: matrix.config.os == 'windows-latest'
        shell: pwsh
        run: |
          $gopath = go env GOPATH
          "$gopath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # Build binaries with platform-specific config
      - name: Build with GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: latest
          args: build --snapshot --clean --config ${{ matrix.config.goreleaser_config }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload binaries as artifacts for inspection
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: test-binaries-${{ matrix.config.name }}
          path: dist/*
          retention-days: 7
