---
name: Test Build Matrix
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

env:
  GO_VERSION: '1.24.11'

jobs:
  # Test build binaries on each platform without creating release
  build:
    name: Build ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - name: Linux
            os: ubuntu-latest
            build_ids:
              - server-linux
              - client-linux
              - client-linux-opencl
              - client-linux-cuda
            setup_cuda: true
            setup_opencl: true
          - name: macOS
            os: macos-latest
            build_ids:
              - server-darwin
              - client-darwin
              - client-darwin-opencl
            setup_cuda: false
            setup_opencl: false  # macOS has OpenCL built-in
          - name: Windows
            os: windows-latest
            build_ids:
              - server-windows
              - client-windows
              - client-windows-opencl
            setup_cuda: false
            setup_opencl: true

    steps:
      - name: Set up git repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: "**/*.sum"

      # Linux-specific dependencies
      - name: Install protobuf compiler (Linux)
        if: matrix.config.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install CUDA toolkit (Linux)
        if: matrix.config.setup_cuda
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          rm cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y cuda-toolkit-12-6
          echo "PATH=/usr/local/cuda/bin:$PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/lib64/stubs:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Install OpenCL headers (Linux)
        if: matrix.config.os == 'ubuntu-latest' && matrix.config.setup_opencl
        run: |
          sudo apt-get install -y opencl-headers ocl-icd-opencl-dev

      # macOS-specific dependencies
      - name: Install protobuf compiler (macOS)
        if: matrix.config.os == 'macos-latest'
        run: brew install protobuf

      # Windows-specific dependencies
      - name: Install protobuf compiler (Windows)
        if: matrix.config.os == 'windows-latest'
        run: choco install protoc

      - name: Install OpenCL SDK (Windows)
        if: matrix.config.os == 'windows-latest' && matrix.config.setup_opencl
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          C:\vcpkg\vcpkg.exe install opencl --triplet=x64-windows
          "OPENCL_ROOT=C:\vcpkg\installed\x64-windows" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CGO_CFLAGS=-IC:\vcpkg\installed\x64-windows\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CGO_LDFLAGS=-LC:\vcpkg\installed\x64-windows\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # Common Go tools setup
      - name: Install Go tools
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Fix GOPATH (Unix)
        if: matrix.config.os != 'windows-latest'
        run: echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Fix GOPATH (Windows)
        if: matrix.config.os == 'windows-latest'
        shell: pwsh
        run: |
          $gopath = go env GOPATH
          "$gopath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # Install GoReleaser
      - name: Set up GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: latest
          install-only: true

      # Build binaries with platform-specific IDs
      - name: Build with GoReleaser
        shell: bash
        run: |
          ARGS=(build --snapshot --clean)
          IDS='${{ toJSON(matrix.config.build_ids) }}'
          for id in $(echo "$IDS" | jq -r '.[]'); do
            ARGS+=(--id "$id")
          done
          goreleaser "${ARGS[@]}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload binaries as artifacts for inspection
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: test-binaries-${{ matrix.config.name }}
          path: dist/*
          retention-days: 7
